<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Tradingbot Dashboard</title>
    <style>
        body {
            font-size: 12px; /* 츿ndra h칛r s친 p친verkas all text p친 sidan */
        }
        h1 { color: #333; }
        .status { margin-bottom: 1em; }
        button { margin-right: 1em; }
        .section {
            margin-bottom: 2em;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 1.5em;
            max-width: 1000px;
        }
        table {
            background: #222;
            color: #eee;
            padding: 1em;
            border-radius: 5px;
            max-width: 900px;
            width: 100%;
            margin-top: 1em;
            border-collapse: collapse;
        }
        th {
            font-size: 18px;
            background: #333;
            padding: 0.5em 1em;
        }
        td {
            font-size: 16px;
            padding: 0.5em 1em;
        }
        .status-executed {
            color: #2ecc40 !important;
            font-weight: bold;
            background: #eaffea !important;
            border-radius: 4px;
            border: 1px solid #2ecc40;
        }
        .status-canceled {
            color: #ff4136 !important;
            font-weight: bold;
            background: #ffeaea !important;
            border-radius: 4px;
            border: 1px solid #ff4136;
        }
        .status-other {
            color: #ffb700 !important;
            font-weight: bold;
            background: #fffbe6 !important;
            border-radius: 4px;
            border: 1px solid #ffb700;
        }
        .card-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 0.5em;
            display: flex;
            align-items: center;
        }
        .card-title i {
            margin-right: 0.5em;
        }
        .balance-key { font-weight: bold; }
        .balance-row { border-bottom: 1px solid #444; }
        @media (max-width: 700px) {
            table, th, td { font-size: 13px; }
            .section { padding: 0.5em; }
        }
        body, table, th, td {
    font-size: 15px; /* 츿ndra till 칬nskad storlek */
}
        .scroll-table {
            display: block;
            max-height: 350px;
            overflow-y: auto;
            border-radius: 5px;
            border: 1px solid #ccc;
            background: #222;
        }
    </style>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-..." crossorigin="anonymous">
    <!-- Chart.js CDN -->
    <!-- Optional FontAwesome -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body class="bg-light">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Tradingbot</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="#status-section">Status</a></li>
          <li class="nav-item"><a class="nav-link" href="#balance-section">Saldo</a></li>
          <li class="nav-item"><a class="nav-link" href="#orders-section">Senaste ordrar</a></li>
          <li class="nav-item"><a class="nav-link" href="#history-section">Orderhistorik</a></li>
          <li class="nav-item"><a class="nav-link" href="#openorders-section">Aktiva ordrar</a></li>
          <li class="nav-item"><a class="nav-link" href="#chart-section">Prisgraf</a></li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-3 d-none d-md-block">
        <!-- Sidebar navigation -->
        <div class="list-group position-sticky" style="top:100px;">
          <a href="#status-section" class="list-group-item list-group-item-action">Status</a>
          <a href="#balance-section" class="list-group-item list-group-item-action">Saldo</a>
          <a href="#orders-section" class="list-group-item list-group-item-action">Senaste ordrar</a>
          <a href="#history-section" class="list-group-item list-group-item-action">Orderhistorik</a>
          <a href="#openorders-section" class="list-group-item list-group-item-action">Aktiva ordrar</a>
          <a href="#chart-section" class="list-group-item list-group-item-action">Prisgraf</a>
        </div>
      </div>
      <div class="col-md-9">
        <!-- Main content -->
        <section id="status-section" class="mb-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="section status">
                <strong>Status:</strong> <span id="bot-status">Laddar...</span>
                <button onclick="startBot()">Starta bot</button>
                <button onclick="stopBot()">Stoppa bot</button>
              </div>
            </div>
          </div>
        </section>
        <section id="balance-section" class="mb-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="section">
                <div class="card-title"><i>游눯</i> Saldo</div>
                <table id="balance-table"></table>
              </div>
            </div>
          </div>
        </section>
        <section id="orders-section" class="mb-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="section">
                <div class="card-title"><i>游늶</i> Senaste ordrar
                    <span id="orders-summary" style="margin-left:1em;font-size:0.9em;color:#888;"></span>
                </div>
                <div class="scroll-table">
                    <table id="orders-table">
                        <thead><tr><th>Tid</th><th>Order-ID</th><th>Symbol</th><th>Typ</th><th>Side</th><th>Pris</th><th>M칛ngd</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
              </div>
            </div>
          </div>
        </section>
        <section id="history-section" class="mb-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="section">
                <div class="card-title"><i>游닆</i> Orderhistorik (max 10 rader)
                    <span id="orderhistory-summary" style="margin-left:1em;font-size:0.9em;color:#888;"></span>
                </div>
                <form id="orderhistory-form" onsubmit="return fetchOrderHistory();">
                    <label>Symbol:
                        <input type="text" id="history-symbol" placeholder="t.ex. tBTCUSD">
                    </label>
                    <label>Datum (YYYY-MM-DD):
                        <input type="text" id="history-date" placeholder="2025-04-29">
                    </label>
                    <button type="submit">Visa orderhistorik</button>
                </form>
                <div class="scroll-table">
                    <table id="orderhistory-table">
                        <thead><tr><th>Tid</th><th>Order-ID</th><th>Symbol</th><th>Typ</th><th>Side</th><th>Pris</th><th>M칛ngd</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
              </div>
            </div>
          </div>
        </section>
        <section id="openorders-section" class="mb-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="section">
                <div class="card-title"><i>游릭</i> Aktiva ordrar</div>
                <table id="openorders-table">
                    <thead><tr><th>Order-ID</th><th>Symbol</th><th>Typ</th><th>Side</th><th>Pris</th><th>M칛ngd</th><th>Status</th><th>Tid</th></tr></thead>
                    <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
        <section id="chart-section" class="mb-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="section">
                <strong>Senaste pris:</strong>
                <span id="realtime-price">Laddar...</span>
              </div>
              <div class="section">
                <strong>Strategi-parametrar (config.json):</strong>
                <form id="config-form" onsubmit="return saveConfig();">
                    <textarea id="config-json" rows="12" cols="80" style="font-family:monospace;"></textarea><br>
                    <button type="submit">Spara 칛ndringar</button>
                    <span id="config-result"></span>
                </form>
              </div>
              <div class="section">
                <strong>Skapa order:</strong>
                <form id="order-form" onsubmit="return sendOrder();">
                    <label>Symbol:
                        <select id="order-symbol">
                            <option value="tTESTBTC:TESTUSD">tTESTBTC:TESTUSD</option>
                            <option value="tTESTETH:TESTUSD">tTESTETH:TESTUSD</option>
                            <option value="tTESTLTC:TESTUSD">tTESTLTC:TESTUSD</option>
                        </select>
                    </label>
                    <label>Typ:
                        <select id="order-type">
                            <option value="buy">K칬p</option>
                            <option value="sell">S칛lj</option>
                        </select>
                    </label>
                    <label>M칛ngd:
                        <input type="number" id="order-amount" value="0.001" step="0.0001" min="0.0001" required>
                    </label>
                    <label>Pris (valfritt):
                        <input type="number" id="order-price" step="0.01" min="0">
                    </label>
                    <button type="submit">Skicka order</button>
                </form>
                <div id="order-result"></div>
              </div>
              <div class="section" id="price-chart-section">
                <div class="card-title"><i>游늳</i> Prisgraf (senaste 50 v칛rden)
                    <select id="chart-symbol-select" style="margin-left:1em;">
                        <option value="tTESTBTC:TESTUSD">tTESTBTC:TESTUSD</option>
                        <option value="tTESTETH:TESTUSD">tTESTETH:TESTUSD</option>
                        <option value="tTESTLTC:TESTUSD">tTESTLTC:TESTUSD</option>
                    </select>
                </div>
                <canvas id="priceChart" height="120"></canvas>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>
  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-..." crossorigin="anonymous"></script>
    <script>
    const apiBase = '';

    function updateStatus() {
        fetch(apiBase + '/status')
            .then(r => r.json())
            .then(d => {
                document.getElementById('bot-status').textContent = d.bot_running ? 'IG칀NG' : 'STOPPAD';
            });
    }
    function startBot() {
        fetch(apiBase + '/start', { method: 'POST' })
            .then(async response => {
                const data = await response.json().catch(() => ({}));
                if (!response.ok) {
                    const msg = data.reason || data.error || 'Kunde inte starta bot.';
                    alert('Fel: ' + msg);
                }
            })
            .catch(err => alert('Fel vid anrop: ' + err))
            .finally(() => setTimeout(updateStatus, 1000));
    }

    function stopBot() {
        fetch(apiBase + '/stop', { method: 'POST' })
            .then(async response => {
                const data = await response.json().catch(() => ({}));
                if (!response.ok) {
                    const msg = data.reason || data.error || 'Kunde inte stoppa bot.';
                    alert('Fel: ' + msg);
                }
            })
            .catch(err => alert('Fel vid anrop: ' + err))
            .finally(() => setTimeout(updateStatus, 1000));
    }

    function updateBalance() {
        fetch(apiBase + '/balance')
            .then(r => r.json())
            .then(d => {
                const table = document.getElementById('balance-table');
                table.innerHTML = '';
                if (!d || typeof d !== 'object') {
                    table.innerHTML = '<tr><td>Ingen data</td></tr>';
                    return;
                }
                const showCurrencies = ['BTC', 'USD', 'USDT', 'EUR'];
                let shown = false;
                if (d.total) {
                    for (const key of Object.keys(d.total)) {
                        table.innerHTML += `<tr class='balance-row'><td class='balance-key'>${key} (Total)</td><td>${d.total[key]}</td></tr>`;
                        shown = true;
                    }
                }
                if (d.free) {
                    for (const key of Object.keys(d.free)) {
                        table.innerHTML += `<tr class='balance-row'><td class='balance-key'>${key} (Free)</td><td>${d.free[key]}</td></tr>`;
                        shown = true;
                    }
                }
                if (!shown) {
                    table.innerHTML = '<tr><td>Ingen relevant saldo-info</td></tr>';
                }
            });
    }
    function parseOrderLine(line) {
        // F칬rv칛ntat format: "YYYY-MM-DD HH:MM:SS: Order-ID: 123, Status: EXECUTED, Info: [...]"
        const match = line.match(/^([\d\-: .]+): Order-ID: (\d+), Status: ([^,]+), Info: (.+)$/);
        if (!match) return null;
        let info = match[4];
        let symbol = '', type = '', side = '', price = '', amount = '', infoText = '';
        try {
            // Rensa Python None till JSON null, och enkla till dubbeLA citat
            const cleanInfo = info.replace(/None/g, 'null').replace(/'/g, '"');
            let arr = null;
            try {
                arr = JSON.parse(cleanInfo);
            } catch (e) {
                arr = null;
            }
            if (Array.isArray(arr)) {
                // Bitfinex-format: symbol p친 index 3, typ p친 8, side p친 6, pris p친 16, m칛ngd p친 6, status p친 13
                if (arr[3]) {
                    const m = arr[3].match(/^t?TEST?([A-Z]+):TEST?([A-Z]+)$/i);
                    symbol = m ? m[1].toUpperCase() + '/' + m[2].toUpperCase() : arr[3];
                }
                type = arr[8] || '';
                side = (parseFloat(arr[6]) > 0 ? 'K칬p' : 'S칛lj');
                price = arr[16] || '';
                amount = arr[6] || '';
                infoText = '';
            } else {
                infoText = info;
            }
        } catch (e) {
            infoText = info;
        }
        return {
            time: match[1],
            orderId: match[2],
            status: match[3],
            symbol,
            type,
            side,
            price,
            amount,
            infoText
        };
    }
    function updateOrders() {
        fetch(apiBase + '/orders')
            .then(r => r.json())
            .then(d => {
                const tbody = document.getElementById('orders-table').querySelector('tbody');
                tbody.innerHTML = '';
                let count = 0;
                (d.orders || []).forEach(line => {
                    const order = parseOrderLine(line);
                    if (order) {
                        let statusClass = 'status-other';
                        const status = order.status.toUpperCase();
                        if (status.startsWith('EXECUTED')) statusClass = 'status-executed';
                        else if (status.startsWith('CANCELED')) statusClass = 'status-canceled';
                        tbody.innerHTML += `<tr title='${order.infoText ? order.infoText : ''}'>` +
                            `<td>${order.time}</td><td>${order.orderId}</td><td>${order.symbol}</td><td>${order.type}</td><td>${order.side}</td><td>${order.price}</td><td>${order.amount}</td><td class='${statusClass}'>${order.status}</td></tr>`;
                        count++;
                    } else {
                        tbody.innerHTML += `<tr><td colspan='8'>${line}</td></tr>`;
                    }
                });
                document.getElementById('orders-summary').textContent = `Antal: ${count}`;
            });
    }
    function updateOpenOrders() {
        fetch(apiBase + '/openorders')
            .then(r => r.json())
            .then(d => {
                const tbody = document.getElementById('openorders-table').querySelector('tbody');
                tbody.innerHTML = '';
                if (d.open_orders && d.open_orders.length > 0) {
                    d.open_orders.forEach(order => {
                        tbody.innerHTML += `<tr>
                            <td>${order.id || ''}</td>
                            <td>${order.symbol || ''}</td>
                            <td>${order.type || ''}</td>
                            <td>${order.side || ''}</td>
                            <td>${order.price || ''}</td>
                            <td>${order.amount || ''}</td>
                            <td>${order.status || ''}</td>
                            <td>${order.datetime || ''}</td>
                        </tr>`;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="8">Inga aktiva ordrar</td></tr>';
                }
            });
    }
    function refreshAll() {
        updateStatus();
        updateBalance();
        updateOrders();
        updateOpenOrders();
    }
    setInterval(refreshAll, 5000);
    refreshAll();

    function sendOrder() {
        const symbol = document.getElementById('order-symbol').value;
        const type = document.getElementById('order-type').value;
        const amount = document.getElementById('order-amount').value;
        const price = document.getElementById('order-price').value;
        const payload = { symbol, type, amount };
        if (price) payload.price = price;
        fetch(apiBase + '/order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(d => {
            document.getElementById('order-result').textContent = d.success ? d.message : (d.error || 'Fel vid order');
            updateOrders();
        });
        return false;
    }

    function fetchOrderHistory() {
        const symbol = document.getElementById('history-symbol').value;
        const date = document.getElementById('history-date').value;
        let url = apiBase + '/orderhistory';
        const params = [];
        if (symbol) params.push('symbol=' + encodeURIComponent(symbol));
        if (date) params.push('date=' + encodeURIComponent(date));
        if (params.length) url += '?' + params.join('&');
        fetch(url)
            .then(r => r.json())
            .then(d => {
                const tbody = document.getElementById('orderhistory-table').querySelector('tbody');
                tbody.innerHTML = '';
                let count = 0;
                (d.orders || []).forEach(line => {
                    const order = parseOrderLine(line);
                    if (order) {
                        let statusClass = 'status-other';
                        const status = order.status.toUpperCase();
                        if (status.startsWith('EXECUTED')) statusClass = 'status-executed';
                        else if (status.startsWith('CANCELED')) statusClass = 'status-canceled';
                        tbody.innerHTML += `<tr title='${order.infoText ? order.infoText : ''}'>` +
                            `<td>${order.time}</td><td>${order.orderId}</td><td>${order.symbol}</td><td>${order.type}</td><td>${order.side}</td><td>${order.price}</td><td>${order.amount}</td><td class='${statusClass}'>${order.status}</td></tr>`;
                        count++;
                    } else {
                        tbody.innerHTML += `<tr><td colspan='8'>${line}</td></tr>`;
                    }
                });
                document.getElementById('orderhistory-summary').textContent = `Antal: ${count}`;
            });
        return false;
    }
    // L칛gg till initial laddning av orderhistorik
    fetchOrderHistory();

    // Ta bort anrop till updatePriceChart i updateRealtimePrice

    function updateRealtimePrice() {
        fetch(apiBase + '/realtimedata')
            .then(r => r.json())
            .then(d => {
                if (d.price !== undefined && d.price !== null) {
                    document.getElementById('realtime-price').textContent = d.price + ' (' + d.symbol + ')';
                } else {
                    document.getElementById('realtime-price').textContent = 'Ingen data';
                }
            });
    }
    setInterval(updateRealtimePrice, 5000);
    updateRealtimePrice();

    function loadConfig() {
        fetch(apiBase + '/config')
            .then(r => r.json())
            .then(d => {
                document.getElementById('config-json').value = d.config;
            })
            .catch(e => {
                document.getElementById('config-result').textContent = 'Fel vid laddning av config: ' + e;
            });
    }
    function saveConfig() {
        let configText = document.getElementById('config-json').value;
        let configObj;
        try {
            configObj = JSON.parse(configText);
        } catch (e) {
            document.getElementById('config-result').textContent = 'Fel: Ogiltig JSON!';
            return false;
        }
        fetch(apiBase + '/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(configObj)
        })
        .then(r => r.json())
        .then(d => {
            document.getElementById('config-result').textContent = d.updated ? 'Sparat!' : (d.error || 'Fel vid sparande.');
        })
        .catch(e => {
            document.getElementById('config-result').textContent = 'Fel vid anrop: ' + e;
        });
        return false;
    }
    // Ladda config n칛r sidan laddas
    document.addEventListener('DOMContentLoaded', loadConfig);

    // Live price chart - isolerad och s칛ker med symbolv칛xling
    (function() {
        const chartSection = document.getElementById('price-chart-section');
        const canvas = document.getElementById('priceChart');
        const symbolSelect = document.getElementById('chart-symbol-select');
        if (!chartSection || !canvas || !symbolSelect || typeof Chart === 'undefined') return;
        let priceData = [];
        let timeLabels = [];
        const maxPoints = 50;
        let currentSymbol = symbolSelect.value;
        const ctx = canvas.getContext('2d');
        const priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Pris',
                    data: priceData,
                    borderColor: '#2ecc40',
                    backgroundColor: 'rgba(46,204,64,0.1)',
                    tension: 0.2,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { beginAtZero: false }
                }
            }
        });
        function updatePriceChart(newPrice) {
            const now = new Date();
            const label = now.toLocaleTimeString();
            priceData.push(newPrice);
            timeLabels.push(label);
            if (priceData.length > maxPoints) {
                priceData.shift();
                timeLabels.shift();
            }
            priceChart.update();
        }
        function resetChart() {
            priceData.length = 0;
            timeLabels.length = 0;
            priceChart.update();
        }
        // H칛mta pris f칬r vald symbol
        function pollPriceForChart() {
            fetch(apiBase + '/realtimedata?symbol=' + encodeURIComponent(currentSymbol))
                .then(r => r.json())
                .then(d => {
                    if (d.price !== undefined && d.price !== null) {
                        updatePriceChart(d.price);
                    }
                })
                .catch(() => {});
        }
        let pollInterval = setInterval(pollPriceForChart, 5000);
        pollPriceForChart();
        symbolSelect.addEventListener('change', function() {
            currentSymbol = symbolSelect.value;
            resetChart();
            clearInterval(pollInterval);
            pollInterval = setInterval(pollPriceForChart, 5000);
            pollPriceForChart();
        });
    })();
    </script>
</body>
</html>
